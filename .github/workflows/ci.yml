name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Ruff
        run: python -m ruff check .
      - name: Mypy
        run: python -m mypy src tests
      - name: Pytest
        run: pytest -q -m "not legacy"
      - name: Sanity check markers
        run: python -m kalshi_alpha.dev.sanity_check

  ingestion-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Offline ingestion
        run: |
          python -m kalshi_alpha.datastore.ingest --offline --fixtures tests/fixtures --source bls_cpi --source dol_claims --source treasury_yields --source cleveland_nowcast --source nws_cli --source aaa_gas

  calibration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Calibrate strategies from fixtures
        run: |
          python - <<'PY'
from pathlib import Path
import json

from kalshi_alpha.strategies.cpi import calibrate as cpi_calibrate
from kalshi_alpha.strategies.claims import calibrate as claims_calibrate
from kalshi_alpha.strategies.teny import calibrate as teny_calibrate
from kalshi_alpha.strategies.weather import calibrate as weather_calibrate

fixtures = Path("tests/fixtures")
cpi_calibrate(json.loads((fixtures / "cpi" / "history.json").read_text())['history'])
claims_calibrate(json.loads((fixtures / "claims" / "history.json").read_text())['history'])
teny_calibrate(json.loads((fixtures / "teny" / "history.json").read_text())['history'])
weather_calibrate(json.loads((fixtures / "weather" / "history.json").read_text())['history'])
PY

  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Configure strict quality gates
        run: |
          mkdir -p configs
          cat <<'EOF' > configs/quality_gates.yaml
          metrics:
            series:
              cpi:
                crps_advantage_min: -1000
              claims:
                crps_advantage_min: -1000
                brier_advantage_min: -1000
          data_freshness:
            - name: cleveland
              namespace: cleveland_nowcast/monthly
              timestamp_field: as_of
              max_age_hours: 0
              require_et: true
          reconciliation: []
          monitors:
            tz_not_et: 1
            non_monotone_ladders: 10
            negative_ev_after_fees: 5
          EOF
      - name: Run daily pipeline expecting NO-GO
        run: |
          set +e
          python -m kalshi_alpha.exec.pipelines.daily \
            --mode pre_cpi \
            --offline \
            --driver-fixtures tests/fixtures \
            --scanner-fixtures tests/data_fixtures \
            --family macro
          status=$?
          if [ $status -eq 0 ]; then
            echo "Expected quality gates to block run" >&2
            exit 1
          fi
          if [ ! -f reports/_artifacts/go_no_go.json ]; then
            echo "Missing go/no-go artifact" >&2
            exit 1
          fi
      - name: Verify go/no-go artifact
        run: |
          python - <<'PY'
from pathlib import Path
import json

path = Path("reports/_artifacts/go_no_go.json")
data = json.loads(path.read_text())
if data.get("go") is not False:
    raise SystemExit("go flag should be false")
reasons = data.get("reasons") or []
if not any("data_freshness.cleveland" in reason for reason in reasons):
    raise SystemExit("Expected cleveland data freshness reason")
PY

  today-wrapper:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Run today pipeline offline
        run: |
          python -m kalshi_alpha.exec.pipelines.today \
            --offline \
            --report \
            --paper-ledger \
            --driver-fixtures tests/fixtures \
            --scanner-fixtures tests/data_fixtures \
            --include-weather \
            --fill-alpha 0.6 \
            --slippage-mode depth \
            --impact-cap 0.25 \
            --family macro
      - name: Aggregate ledgers
        run: |
          python -m kalshi_alpha.exec.ledger.aggregate
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: today-reports
          path: reports
          if-no-files-found: warn
      - name: Upload ledger parquet
        uses: actions/upload-artifact@v4
        with:
          name: ledger-parquet
          path: data/proc/ledger_all.parquet
          if-no-files-found: warn

  nightly-offline-pipeline:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Pytest (full)
        run: pytest -q
      - name: Run today pipeline offline (nightly)
        run: |
          python -m kalshi_alpha.exec.pipelines.today \
            --offline \
            --report \
            --paper-ledger \
            --driver-fixtures tests/fixtures \
            --scanner-fixtures tests/data_fixtures \
            --include-weather \
            --fill-alpha auto \
            --slippage-mode depth \
            --impact-cap 0.25
      - name: Aggregate ledgers
        run: |
          python -m kalshi_alpha.exec.ledger.aggregate
      - name: Generate scoreboards
        run: |
          python -m kalshi_alpha.exec.scoreboard
      - name: Sanity check markers
        run: |
          python -m kalshi_alpha.dev.sanity_check
      - name: Housekeeping
        run: |
          python -m kalshi_alpha.exec.housekeep --keep-days 30
      - name: Upload nightly reports
        uses: actions/upload-artifact@v4
        with:
          name: nightly-reports
          path: reports
          if-no-files-found: warn
      - name: Upload nightly ledger parquet
        uses: actions/upload-artifact@v4
        with:
          name: nightly-ledger
          path: data/proc/ledger_all.parquet
          if-no-files-found: warn
