name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Ruff
        run: python -m ruff check .
      - name: Mypy
        run: python -m mypy src tests
      - name: Pytest
        run: pytest -q

  ingestion-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Offline ingestion
        run: |
          python -m kalshi_alpha.datastore.ingest --offline --fixtures tests/fixtures --source bls_cpi --source dol_claims --source treasury_yields --source cleveland_nowcast --source nws_cli --source aaa_gas

  calibration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Calibrate strategies from fixtures
        run: |
          python - <<'PY'
from pathlib import Path
import json

from kalshi_alpha.strategies.cpi import calibrate as cpi_calibrate
from kalshi_alpha.strategies.claims import calibrate as claims_calibrate
from kalshi_alpha.strategies.teny import calibrate as teny_calibrate
from kalshi_alpha.strategies.weather import calibrate as weather_calibrate

fixtures = Path("tests/fixtures")
cpi_calibrate(json.loads((fixtures / "cpi" / "history.json").read_text())['history'])
claims_calibrate(json.loads((fixtures / "claims" / "history.json").read_text())['history'])
teny_calibrate(json.loads((fixtures / "teny" / "history.json").read_text())['history'])
weather_calibrate(json.loads((fixtures / "weather" / "history.json").read_text())['history'])
PY

  nightly-backtest:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Run fixture backtests
        run: pytest tests/test_strategy_models.py -q
